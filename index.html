<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebChat - Disable SendBox with Suggestions (Recompose)</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
    }
    #root {
      height: 100%;
      max-width: 480px;
      margin: 0 auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    /* WebChat's internal wrappers need height to pass through */
    #root > div {
      height: 100%;
    }
    #root > div > div {
      height: 100%;
    }

    /* Layout for our recomposed chat */
    .chat-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #fff;
    }
    .chat-layout__transcript {
      flex: 1;
      overflow: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    /* Our SendBox wrapper - we control this element */
    .sendbox-wrapper {
      position: relative;
    }
    /* Visual hint when input is disabled */
    .sendbox-wrapper--disabled [data-id="webchat-sendbox-input"] {
      opacity: 0.5;
      caret-color: transparent;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/rxjs@7/dist/bundles/rxjs.umd.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <script>
    (function() {
      'use strict';

      var React = window.React;
      var ReactDOM = window.ReactDOM;
      var createElement = React.createElement;

      // WebChat exports - following official recompose pattern
      var Components = window.WebChat.Components;
      var Composer = Components.Composer;
      var AccessKeySinkSurface = Components.AccessKeySinkSurface;
      var BasicToaster = Components.BasicToaster;
      var BasicTranscript = Components.BasicTranscript;
      var BasicConnectivityStatus = Components.BasicConnectivityStatus;
      var BasicSendBox = Components.BasicSendBox;
      var useSuggestedActions = window.WebChat.hooks.useSuggestedActions;
      var useEffect = React.useEffect;
      var useRef = React.useRef;

      // =====================
      // MOCK DIRECTLINE
      // =====================
      function createMockDirectLine() {
        var Subject = rxjs.Subject;
        var BehaviorSubject = rxjs.BehaviorSubject;
        var Observable = rxjs.Observable;

        var activitySubject = new Subject();
        var connectionStatus = new BehaviorSubject(0);
        var counter = 0;
        var handlers = [];

        setTimeout(function() { connectionStatus.next(1); }, 50);
        setTimeout(function() { connectionStatus.next(2); }, 100);

        return {
          activity$: activitySubject.asObservable(),
          connectionStatus$: connectionStatus.asObservable(),
          end: function() {},
          getSessionId: function() {
            return new Observable(function(obs) {
              obs.next('session-' + Date.now());
              obs.complete();
            });
          },
          postActivity: function(activity) {
            return new Observable(function(obs) {
              var id = 'user-' + (++counter);
              setTimeout(function() {
                handlers.forEach(function(h) { h(activity); });
                obs.next(id);
                obs.complete();
              }, 10);
            });
          },
          onUserMessage: function(handler) { handlers.push(handler); },
          sendBotMessage: function(text, suggestions) {
            var activity = {
              id: 'bot-' + (++counter),
              type: 'message',
              timestamp: new Date().toISOString(),
              from: { id: 'bot', role: 'bot' },
              text: text
            };
            if (suggestions && suggestions.length) {
              activity.suggestedActions = {
                actions: suggestions.map(function(s) {
                  return { type: 'imBack', title: s.title, value: s.value || s.title };
                })
              };
            }
            activitySubject.next(activity);
          },
          sendTyping: function() {
            activitySubject.next({
              id: 'typing-' + (++counter),
              type: 'typing',
              timestamp: new Date().toISOString(),
              from: { id: 'bot', role: 'bot' }
            });
          }
        };
      }

      // =====================
      // CONVERSATION FLOW
      // =====================
      function setupFlow(dl) {
        var mainMenu = [
          { title: 'Food', value: 'food' },
          { title: 'Entertainment', value: 'entertainment' },
          { title: 'Help', value: 'help' }
        ];

        var subMenus = {
          food: { text: 'What would you like to eat?', options: [
            { title: 'Pizza', value: 'pizza' },
            { title: 'Burger', value: 'burger' },
            { title: 'Sushi', value: 'sushi' },
            { title: 'Back', value: 'back' }
          ]},
          entertainment: { text: 'What kind of entertainment?', options: [
            { title: 'Movies', value: 'movies' },
            { title: 'Music', value: 'music' },
            { title: 'Games', value: 'games' },
            { title: 'Back', value: 'back' }
          ]},
          help: { text: 'What do you need help with?', options: [
            { title: 'Account', value: 'account' },
            { title: 'Orders', value: 'orders' },
            { title: 'Contact', value: 'contact' },
            { title: 'Back', value: 'back' }
          ]}
        };

        var responses = {
          pizza: 'Your pizza is on the way! ETA: 30 min.',
          burger: 'Burger order confirmed! ETA: 25 min.',
          sushi: 'Fresh sushi coming up! ETA: 40 min.',
          movies: 'Top picks: Inception, The Matrix, Interstellar.',
          music: 'Playing your favorites now!',
          games: 'Game on! Choose: Chess, Trivia, or Puzzles.',
          account: 'Your account is active. Email: user@example.com',
          orders: 'You have 2 pending orders.',
          contact: 'Support contacted. Response within 24h.'
        };

        dl.onUserMessage(function(activity) {
          if (!activity.text) return;
          var input = activity.text.toLowerCase().trim();

          setTimeout(function() {
            dl.sendTyping();
            setTimeout(function() {
              if (input === 'back') {
                dl.sendBotMessage('What would you like to do?', mainMenu);
                return;
              }
              if (subMenus[input]) {
                dl.sendBotMessage(subMenus[input].text, subMenus[input].options);
                return;
              }
              if (responses[input]) {
                dl.sendBotMessage(responses[input], null);
                setTimeout(function() {
                  dl.sendBotMessage('Anything else?', mainMenu);
                }, 1500);
                return;
              }
              dl.sendBotMessage('Here are your options:', mainMenu);
            }, 600);
          }, 200);
        });

        setTimeout(function() {
          dl.sendBotMessage('Hi! Type anything to see the menu.', null);
        }, 400);
      }

      // =====================
      // RECOMPOSED CHAT UI
      // =====================
      // Following official pattern: Composer > AccessKeySinkSurface > Basic* components
      // We wrap BasicSendBox in our own div to control disabled state
      function RecomposedChat() {
        var result = useSuggestedActions();
        var suggestedActions = result[0];
        var hasSuggestions = suggestedActions && suggestedActions.length > 0;
        var wrapperRef = useRef(null);

        // Block input when suggestions are present (without using disabled which WebChat propagates)
        useEffect(function() {
          if (!wrapperRef.current) return;
          var input = wrapperRef.current.querySelector('[data-id="webchat-sendbox-input"]');
          if (!input) return;

          function blockInput(e) {
            if (hasSuggestions) {
              e.preventDefault();
              e.stopPropagation();
            }
          }

          if (hasSuggestions) {
            input.addEventListener('keydown', blockInput, true);
            input.addEventListener('keypress', blockInput, true);
            input.addEventListener('paste', blockInput, true);
            // Remove focus so cursor isn't visible
            if (document.activeElement === input) {
              input.blur();
            }
            // Clear any existing value when suggestions appear
            if (input.value) {
              // Dispatch input event to sync React state
              var nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;
              nativeInputValueSetter.call(input, '');
              input.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }

          return function() {
            input.removeEventListener('keydown', blockInput, true);
            input.removeEventListener('keypress', blockInput, true);
            input.removeEventListener('paste', blockInput, true);
          };
        }, [hasSuggestions]);

        var wrapperClass = 'sendbox-wrapper' + (hasSuggestions ? ' sendbox-wrapper--disabled' : '');

        return createElement(AccessKeySinkSurface, null,
          createElement('div', { className: 'chat-layout' },
            createElement(BasicToaster, null),
            createElement('div', { className: 'chat-layout__transcript' },
              createElement(BasicTranscript, null)
            ),
            createElement(BasicConnectivityStatus, null),
            // Our wrapper around BasicSendBox
            createElement('div', {
              ref: wrapperRef,
              className: wrapperClass,
              'data-testid': 'sendbox-wrapper',
              'aria-disabled': hasSuggestions
            },
              createElement(BasicSendBox, null)
            )
          )
        );
      }

      // =====================
      // INIT
      // =====================
      var directLine = createMockDirectLine();
      setupFlow(directLine);

      var styleOptions = {
        bubbleBackground: '#e8f4fd',
        bubbleTextColor: '#1a1a1a',
        bubbleBorderRadius: 12,
        bubbleFromUserBackground: '#0078d4',
        bubbleFromUserTextColor: '#ffffff',
        bubbleFromUserBorderRadius: 12,
        suggestedActionLayout: 'stacked',
        suggestedActionBackgroundColor: '#0078d4',
        suggestedActionBorderColor: 'transparent',
        suggestedActionBorderRadius: 16,
        suggestedActionTextColor: '#ffffff',
        suggestedActionHeight: 40,
        hideUploadButton: true
      };

      var root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        createElement(Composer, {
          directLine: directLine,
          styleOptions: styleOptions
        },
          createElement(RecomposedChat)
        )
      );

      console.log('WebChat initialized with recomposed UI (official pattern)');
    })();
  </script>
</body>
</html>
